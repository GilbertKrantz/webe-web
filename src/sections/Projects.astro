---
import { icons } from 'lucide-static';
import type { Project } from '../lib/types';

const arrowUpRightIcon = icons['arrow-up-right'];

interface Props {
  projects: Project[];
}

const { projects } = Astro.props;
---

<section
  id="projects"
  class="projects-section relative bg-background z-30 py-[8vh] px-4 md:px-[7vw]"
>
  {/* Header */}
  <div class="projects-header flex flex-col md:flex-row md:items-end justify-between mb-[6vh] pb-6 border-b border-white/10 gap-4">
    <h2 class="text-[clamp(32px,10vw,56px)] md:text-[clamp(40px,5vw,56px)] font-bold text-foreground">
      PROJECTS
    </h2>
    <span class="font-mono text-xs uppercase tracking-[0.14em] text-muted-foreground">
      Selected Work
    </span>
  </div>

  {/* Project Cards */}
  <div class="space-y-0">
    {projects.map((project) => (
      <div
        class="project-card relative border-b border-white/10 py-8 md:py-12"
      >
        {/* Horizontal line */}
        <div
          class="card-line absolute top-0 left-0 w-full h-px line-secondary origin-left scale-x-0"
        ></div>

        <div class="flex flex-col md:flex-row md:items-start gap-4 md:gap-8">
          {/* Number */}
          <div class="card-number flex-shrink-0">
            <span class="text-[clamp(48px,12vw,80px)] md:text-[clamp(64px,8vw,100px)] font-bold text-primary/10 leading-none">
              0{project.id}
            </span>
          </div>

          {/* Content */}
          <div class="card-content flex-1">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-2 md:gap-4 mb-4">
              <div>
                <h3 class="text-[clamp(24px,6vw,40px)] md:text-[clamp(28px,3vw,44px)] font-bold text-foreground mb-1">
                  {project.title}
                </h3>
                <p class="text-muted-foreground text-base md:text-lg">
                  {project.subtitle}
                </p>
              </div>
              <span class="font-mono text-xs uppercase tracking-[0.14em] text-primary">
                {project.meta}
              </span>
            </div>

            <p class="text-muted-foreground text-sm md:text-base leading-relaxed mb-4 md:mb-6 max-w-[90vw] md:max-w-[70%]">
              {project.description}
            </p>

            {/* Case Study Link */}
            {project.hasLink && project.linkUrl ? (
              <a
                href={project.linkUrl}
                class="group inline-flex items-center gap-2 text-foreground font-mono text-sm uppercase tracking-[0.14em] hover:text-primary transition-colors"
              >
                View case study
                <svg class="w-4 h-4 group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform" set:html={arrowUpRightIcon} />
              </a>
            ) : (
              <span class="inline-flex items-center gap-2 text-muted-foreground/40 font-mono text-sm uppercase tracking-[0.14em] cursor-default">
                View case study
                <svg class="w-4 h-4" set:html={arrowUpRightIcon} />
              </span>
            )}
          </div>
        </div>
      </div>
    ))}
  </div>
</section>

<script>
  import gsap from 'gsap';
  import ScrollTrigger from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  const initProjects = () => {
    // Clean up existing ScrollTrigger instances
    ScrollTrigger.getAll().forEach((trigger) => {
      const triggerElement = trigger.vars.trigger;
      if (typeof triggerElement === 'string' && triggerElement.includes('.projects-section')) {
        trigger.kill();
      } else if (typeof triggerElement === 'object' && triggerElement?.closest?.('.projects-section')) {
        trigger.kill();
      }
    });

    const section = document.querySelector('.projects-section');
    if (!section) return;

    const header = section.querySelector('.projects-header');
    const cards = section.querySelectorAll('.project-card');

    // Header animation
    gsap.fromTo(header,
      { y: '-6vh', opacity: 0 },
      {
        y: 0,
        opacity: 1,
        scrollTrigger: {
          trigger: header,
          start: 'top 80%',
          end: 'top 50%',
          scrub: true
        }
      }
    );

    // Card animations
    cards.forEach((card) => {
      const content = card.querySelector('.card-content');
      const number = card.querySelector('.card-number');
      const line = card.querySelector('.card-line');

      gsap.fromTo(number,
        { x: '-5vw', opacity: 0 },
        {
          x: 0,
          opacity: 1,
          scrollTrigger: {
            trigger: card,
            start: 'top 75%',
            end: 'top 40%',
            scrub: true
          }
        }
      );

      gsap.fromTo(content,
        { x: '5vw', opacity: 0 },
        {
          x: 0,
          opacity: 1,
          scrollTrigger: {
            trigger: card,
            start: 'top 75%',
            end: 'top 40%',
            scrub: true
          }
        }
      );

      gsap.fromTo(line,
        { scaleX: 0 },
        {
          scaleX: 1,
          transformOrigin: 'left',
          scrollTrigger: {
            trigger: card,
            start: 'top 70%',
            end: 'top 45%',
            scrub: true
          }
        }
      );
    });
  };

  initProjects();
  document.addEventListener('astro:after-swap', initProjects);
</script>

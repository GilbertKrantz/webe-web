---
import type { Experience as ExperienceType } from '../lib/types';

interface Props {
  experiences: ExperienceType[];
}

const { experiences } = Astro.props;
---

<section
  id="experience"
  class="experience-section relative bg-background z-40 py-[8vh] px-4 md:px-[7vw]"
>
  {/* Section Header */}
  <div class="experience-header flex flex-col md:flex-row md:items-end justify-between mb-[6vh] pb-6 border-b border-white/10 gap-4">
    <h2 class="text-[clamp(32px,10vw,56px)] md:text-[clamp(40px,5vw,56px)] font-bold text-foreground">
      EXPERIENCE
    </h2>
    <span class="font-mono text-xs uppercase tracking-[0.14em] text-muted-foreground">
      Career
    </span>
  </div>

  {/* Experience Entries */}
  <div class="space-y-0">
    {experiences.map((exp) => (
      <div
        class="experience-entry relative border-b border-white/10 py-8 md:py-12 opacity-0"
      >
        <div class="flex flex-col md:flex-row md:items-start gap-4 md:gap-8">
          {/* Date - left side on desktop */}
          <div class="md:w-[20%] flex-shrink-0">
            <span class="font-mono text-xs md:text-sm uppercase tracking-[0.14em] text-primary">
              {exp.dateRange}
            </span>
          </div>

          {/* Content */}
          <div class="flex-1">
            <div class="mb-4">
              <h3 class="text-[clamp(20px,5vw,32px)] md:text-[clamp(24px,2.5vw,32px)] font-bold text-foreground mb-1">
                {exp.role}
              </h3>
              <p class="text-muted-foreground text-base md:text-lg">
                {exp.company}
              </p>
            </div>

            {/* Bullets */}
            <ul class="space-y-2 md:space-y-3">
              {exp.bullets.map((bullet) => (
                <li class="flex items-start gap-3">
                  <span
                    class="bullet-square lime-square mt-1.5 flex-shrink-0 scale-0"
                  ></span>
                  <span class="text-muted-foreground text-sm md:text-base leading-relaxed">
                    {bullet}
                  </span>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>
    ))}
  </div>
</section>

<script>
  import gsap from 'gsap';
  import ScrollTrigger from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  const initExperience = () => {
    // Clean up existing ScrollTrigger instances
    ScrollTrigger.getAll().forEach((trigger) => {
      const triggerElement = trigger.vars.trigger;
      if (triggerElement === '.experience-section' || 
          (typeof triggerElement === 'object' && triggerElement?.closest('.experience-section'))) {
        trigger.kill();
      }
    });

    const section = document.querySelector('.experience-section');
    if (!section) return;

    const header = section.querySelector('.experience-header');
    const entries = section.querySelectorAll('.experience-entry');

    // Header animation
    gsap.fromTo(header,
      { y: '-4vh', opacity: 0 },
      {
        y: 0,
        opacity: 1,
        scrollTrigger: {
          trigger: header,
          start: 'top 80%',
          end: 'top 55%',
          scrub: true
        }
      }
    );

    // Entry animations
    entries.forEach((entry) => {
      gsap.fromTo(entry,
        { x: '8vw', opacity: 0 },
        {
          x: 0,
          opacity: 1,
          scrollTrigger: {
            trigger: entry,
            start: 'top 75%',
            end: 'top 50%',
            scrub: true
          }
        }
      );

      // Bullet squares pop
      const bullets = entry.querySelectorAll('.bullet-square');
      bullets.forEach((bullet, i) => {
        gsap.fromTo(bullet,
          { scale: 0 },
          {
            scale: 1,
            scrollTrigger: {
              trigger: entry,
              start: `top ${65 - (i * 5)}%`,
              end: `top ${50 - (i * 5)}%`,
              scrub: true
            }
          }
        );
      });
    });
  };

  initExperience();
  document.addEventListener('astro:after-swap', initExperience);
</script>

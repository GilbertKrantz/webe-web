---
import BaseLayout from "../layouts/BaseLayout.astro";
import Navigation from "../components/Navigation";
import Hero from "../sections/Hero.astro";
import About from "../sections/About.astro";
import Projects from "../sections/Projects.astro";
import Experience from "../sections/Experience.astro";
import Publications from "../sections/Publications.astro";
import Skills from "../sections/Skills.astro";
import Contact from "../sections/Contact.astro";
import ThankYou from "../sections/ThankYou.astro";
import Footer from "../sections/Footer.astro";
import { Chatbot } from "../components/Chatbot";
import { getAllPortfolioData } from "../lib/db";

// Fetch all portfolio data from database
console.log('--- SERVER SIDE RENDERING index.astro ---');
console.log('POSTGRES_URL length:', import.meta.env.POSTGRES_URL?.length || 0);
const { experiences, projects, skillCategories, publications } =
	await getAllPortfolioData();
console.log('Data fetched:', { 
  exp: experiences.length, 
  proj: projects.length, 
  skills: skillCategories.length, 
  pub: publications.length 
});
---

<BaseLayout>
	<Navigation client:load />
	<main class="relative">
		<div class="content-auto"><Hero /></div>
		<div class="content-auto"><About /></div>
		<div class="content-auto">
			<Projects projects={projects} />
		</div>
		<div class="content-auto">
			<Experience experiences={experiences} />
		</div>
		<div class="content-auto">
			<Publications publications={publications} />
		</div>
		<div class="content-auto">
			<Skills skillCategories={skillCategories} />
		</div>
		<div class="content-auto"><Contact /></div>
		<div class="content-auto"><ThankYou /></div>
		<Footer />
		<Chatbot client:idle />
	</main>
</BaseLayout>

<script>
	import gsap from "gsap";
	import ScrollTrigger from "gsap/ScrollTrigger";

	gsap.registerPlugin(ScrollTrigger);

	// Global Scroll Snap logic from App.tsx
	const initScrollSnap = () => {
		const timeout = setTimeout(() => {
			const pinned = ScrollTrigger.getAll()
				.filter((st) => st.vars.pin)
				.sort((a, b) => a.start - b.start);

			const maxScroll = ScrollTrigger.maxScroll(window);

			if (!maxScroll || pinned.length === 0) return;

			const pinnedRanges = pinned.map((st) => ({
				start: st.start / maxScroll,
				end: (st.end ?? st.start) / maxScroll,
				center:
					(st.start + ((st.end ?? st.start) - st.start) * 0.5) /
					maxScroll,
			}));

			ScrollTrigger.create({
				snap: {
					snapTo: (value: number) => {
						const inPinned = pinnedRanges.some(
							(r) =>
								value >= r.start - 0.02 &&
								value <= r.end + 0.02,
						);

						if (!inPinned) return value;

						const target = pinnedRanges.reduce(
							(closest, r) =>
								Math.abs(r.center - value) <
								Math.abs(closest - value)
									? r.center
									: closest,
							pinnedRanges[0]?.center ?? 0,
						);

						return target;
					},
					duration: { min: 0.15, max: 0.35 },
					delay: 0,
					ease: "power2.out",
				},
			});
		}, 100);

		return () => clearTimeout(timeout);
	};

	// Run on initial load
	initScrollSnap();

	// If using view transitions, you might need to re-run on 'astro:after-swap'
</script>
